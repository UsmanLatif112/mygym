{% extends "base.html" %}
{% set hide_sidebar = True %}
{% block content %}
<div class="add-customer-full-bg">
  <div class="add-customer-card">
    <a href="{{ url_for('customers') }}" class="back-btn"><i class="fa fa-arrow-left"></i> Back</a>
    <h1>Add Customer</h1>
    <form method="POST" class="customer-form">
        {{ form.hidden_tag() }}

        <div class="form-block">
            <label>Membership No:</label>
            <span class="readonly-field">{{ membership_no }}</span>
        </div>
        <div class="form-block">
            <label for="admission_date">Admission Date:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.admission_date(class_="form-input", id="admission_date") }}
            {% for error in form.admission_date.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-block">
            <label for="name">Full Name:<span style="font-weight:400; color:#FF0000;">*</span></label>

            {{ form.name(class_="form-input", id="name", placeholder="Please enter your name here..") }}
            {% for error in form.name.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="father_or_husband">Father/Husband Name:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.father_or_husband(class_="form-input", id="father_or_husband",placeholder="Please enter your father/husband name here..") }}
            {% for error in form.father_or_husband.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="cnic">CNIC:<span style="font-weight:400; color:#FF0000;">*</span></label>
            <input type="text"
                name="cnic"
                id="cnic"
                class="form-input"
                maxlength="15"
                placeholder="12345-1122334-5"
                autocomplete="off"
                required>
            <span class="form-error" id="cnicError" style="display:none;"></span>
        </div>

        <div class="form-block">
            <label for="email">Email:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.email(class_="form-input", id="email", placeholder="Please enter your email  e.g example@gmail.com") }}
            {% for error in form.email.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="gender">Gender:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.gender(class_="form-input", id="gender") }}
            {% for error in form.gender.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="marital_status">Marital Status:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.marital_status(class_="form-input", id="marital_status") }}
            {% for error in form.marital_status.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="blood_group">Blood Group:<span style="font-weight:400; color:#aaa;">(optional)</span></label>
            {{ form.blood_group(class_="form-input", id="blood_group") }}
            {% for error in form.blood_group.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="dob">Date of Birth:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.dob(class_="form-input", id="dob", type="date") }}
            {% for error in form.dob.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="weight">Weight (kg):<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.weight(class_="form-input", id="weight", placeholder="Please enter your weight here..") }}
            {% for error in form.weight.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="height">Height (cm):<span style="font-weight:400; color:#aaa;">(optional)</span></label>
            {{ form.height(class_="form-input", id="height", placeholder="Please enter your height here..") }}
            {% for error in form.height.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="waist">Waist (cm):<span style="font-weight:400; color:#aaa;">(optional)</span></label>
            {{ form.waist(class_="form-input", id="waist", placeholder="Please enter your waist here..") }}
            {% for error in form.waist.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="profession">Profession:<span style="font-weight:400; color:#aaa;">(optional)</span></label>
            {{ form.profession(class_="form-input", id="profession", placeholder="Please enter your profession here..") }}
            {% for error in form.profession.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="nationality">Nationality:<span style="font-weight:400; color:#aaa;">(optional)</span></label>
            {{ form.nationality(class_="form-input", id="nationality", placeholder="Please enter your nationality here..") }}
            {% for error in form.nationality.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="address">Address:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.address(class_="form-input textarea-nonresize", id="address", placeholder="Please enter your address here..") }}
            {% for error in form.address.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="phone">Phone Number:<span style="font-weight:400; color:#FF0000;">*</span></label>
            <input type="text"
                name="phone"
                id="phone"
                class="form-input"
                maxlength="11"
                placeholder="03XXXXXXXXX"
                autocomplete="off"
                required>
            <span class="form-error" id="phoneError" style="display:none;"></span>
        </div>
        <div class="form-block">
            <label for="emergency_contact">Emergency Contact No:<span style="font-weight:400; color:#FF0000;">*</span></label>
            <input type="text"
                name="emergency_contact"
                id="emergency_contact"
                class="form-input"
                maxlength="11"
                placeholder="03XXXXXXXXX"
                autocomplete="off"
                required>
            <span class="form-error" id="emergencyContactError" style="display:none;"></span>
        </div>
        
        <div class="form-block">
    <label for="training_type">Training Type:<span style="font-weight:400; color:#FF0000;">*</span></label>
    {{ form.training_type(class_="form-input", id="training_type") }}
    {% for error in form.training_type.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}
</div>

<div class="form-block">
    <label for="package">Package:<span style="font-weight:400; color:#FF0000;">*</span></label>
    <select name="package" class="form-input" id="package">
        {% for val, label in individual_packages %}
            <option value="{{ val }}" {% if form.package.data == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    {% for error in form.package.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}
</div>

<div class="form-block" id="personal_training_time_row" style="display:none;">
    <label for="trainer">Trainer<span style="font-weight:400; color:#FF0000;">*</span></label>
    <select name="trainer" class="form-input" id="trainer">
        <option value="">Select Trainer</option>
        {% for t in trainers %}
            <option value="{{ t.name }}" data-timing="{{ t.timing or '' }}"
                {% if form.trainer.data == t.name %}selected{% endif %}>
                {{ t.name }}
            </option>
        {% endfor %}
    </select>
    <label for="personal_training_time">Preferred Training Time</label>
    {{ form.personal_training_time(class_="form-input", id="personal_training_time", readonly=True) }}
</div>

        <div class="form-block">
            <label for="bmi_test">BMI Test:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.bmi_test(class_="form-input", id="bmi_test") }}
            {% for error in form.bmi_test.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block" id="bmi_value_row" style="display:none;">
            <label for="bmi_value">BMI Value:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.bmi_value(class_="form-input", id="bmi_value") }}
            {% for error in form.bmi_value.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <a href="https://mygymlahore.com/bmi-calculator.html" target="_blank" style="color:#58a6ff;">Go to BMI Calculator</a>
        </div>
        <div class="form-block">
            <label for="illnesses">Do you suffer from any of these illnesses?:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.illnesses(class_="form-input", id="illnesses", placeholder="Please select your illnesses or decribe if any here..") }}
            {% for error in form.illnesses.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="join_reasons">Why do you want to join?:<span style="font-weight:400; color:#FF0000;">*</span></label>
            {{ form.join_reasons(class_="form-input", id="join_reasons" , placeholder="Please select your reasons or decribe if any here..") }}
            {% for error in form.join_reasons.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-blockcheck terms-row">
            {{ form.terms_accepted() }} {{ form.terms_accepted.label }}
            <a href="{{ url_for('terms') }}" target="_blank" style="color:#58a6ff;">Terms and Conditions</a>
            {% for error in form.terms_accepted.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            {{ form.submit(class_='leet-btn') }}
        </div>
    </form>
  </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var trainerSelect = document.getElementById('trainer');
    var timeInput = document.getElementById('personal_training_time');

    function syncTime() {
        var selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
        var timing = selectedOption ? selectedOption.getAttribute('data-timing') : '';
        timeInput.value = timing || '';
    }

    trainerSelect.addEventListener('change', syncTime);

    // Sync on page load (for edit form)
    syncTime();
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phoneError');

    phoneInput.addEventListener('input', function() {
        let value = phoneInput.value;

        // Check for international code and limit to 11 digits
        if (value.startsWith('+')) {
            phoneError.innerText = "Please enter without country code (e.g., 03001234567).";
            phoneError.style.display = 'block';
        } else if (value.length > 11) {
            phoneInput.value = value.slice(0, 11);
            phoneError.style.display = 'none';
        } else {
            phoneError.style.display = 'none';
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emergencyContactInput = document.getElementById('emergency_contact');
    const emergencyContactError = document.getElementById('emergencyContactError');

    emergencyContactInput.addEventListener('input', function() {
        let value = emergencyContactInput.value;
        // Check for international code and limit to 11 digits
        if (value.startsWith('+')) {
            emergencyContactError.innerText = "Please enter without country code (e.g., 03001234567).";
            emergencyContactError.style.display = 'block';
        } else if (value.length > 11) {
            emergencyContactInput.value = value.slice(0, 11);
            emergencyContactError.style.display = 'none';
        } else {
            emergencyContactError.style.display = 'none';
        }
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    var illnessesWhitelist = [
      "Diabetes", "Blood Pressure", "Heart Disease", "High Cholesterol", "Depression/Anxiety", "Asthma", "Arthritis", "Osteoporosis", "Thyroid Issues", "Back Pain"
    ];
    var joinReasonsWhitelist = [
      "General Fitness", "Weight Reduction", "Dietary Advice", "Stress Management", "Sports Specific Exercise", "Body Building", "Weight Gain"
    ];

    // Illnesses
    var illnessesInput = document.querySelector('#illnesses');
    if (illnessesInput) {
        new Tagify(illnessesInput, {
            whitelist: illnessesWhitelist,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: false
            },
            enforceWhitelist: false, // allows custom values
        });
    }

    // Join Reasons
    var joinReasonsInput = document.querySelector('#join_reasons');
    if (joinReasonsInput) {
        new Tagify(joinReasonsInput, {
            whitelist: joinReasonsWhitelist,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: false
            },
            enforceWhitelist: false,
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var trainingTypeSelect = document.getElementById('training_type');
    var packageSelect = document.getElementById('package');
    var trainerRow = document.getElementById('personal_training_time_row');

    // Get package lists from Flask context
    var individualPackages = {{ individual_packages|tojson }};
    var personalPackages = {{ personal_packages|tojson }};

    function updatePackageOptions() {
        var type = trainingTypeSelect.value;
        var options = (type === 'Personal') ? personalPackages : individualPackages;
        packageSelect.innerHTML = '';
        options.forEach(function(pkg) {
            var opt = document.createElement('option');
            opt.value = pkg[0];
            opt.textContent = pkg[1];
            packageSelect.appendChild(opt);
        });
        // Set first option as selected
        if (options.length > 0) packageSelect.value = options[0][0];
    }
    function toggleTrainerField() {
        if (trainingTypeSelect.value === 'Personal') {
            trainerRow.style.display = 'block';
        } else {
            trainerRow.style.display = 'none';
        }
    }

    trainingTypeSelect.addEventListener('change', function() {
        updatePackageOptions();
        toggleTrainerField();
    });

    // Set initial state
    updatePackageOptions();
    toggleTrainerField();

    // Trainer timing autofill
    var trainerSelect = document.getElementById('trainer');
    var timeInput = document.getElementById('personal_training_time');
    if (trainerSelect && timeInput) {
        function syncTime() {
            var selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
            var timing = selectedOption ? selectedOption.getAttribute('data-timing') : '';
            timeInput.value = timing || '';
        }
        trainerSelect.addEventListener('change', syncTime);
        syncTime();
    }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide trainer row based on training type
    var trainingTypeSelect = document.getElementById('training_type');
    var trainerRow = document.getElementById('personal_training_time_row');

    function toggleTrainerField() {
        if (trainingTypeSelect.value === 'Personal') {
            trainerRow.style.display = 'block';
        } else {
            trainerRow.style.display = 'none';
        }
    }

    trainingTypeSelect.addEventListener('change', toggleTrainerField);
    toggleTrainerField(); // Initialize on page load

    // Preferred Training Time autofill
    var trainerSelect = document.getElementById('trainer');
    var timeInput = document.getElementById('personal_training_time');
    function syncTime() {
        var selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
        var timing = selectedOption ? selectedOption.getAttribute('data-timing') : '';
        timeInput.value = timing || '';
    }
    trainerSelect.addEventListener('change', syncTime);
    syncTime();

    // BMI Test toggle
    var bmiTestSelect = document.getElementById('bmi_test');
    var bmiValueRow = document.getElementById('bmi_value_row');
    function toggleBMIValueRow() {
        if (bmiTestSelect.value === 'Yes') {
            bmiValueRow.style.display = 'block';
        } else {
            bmiValueRow.style.display = 'none';
        }
    }
    bmiTestSelect.addEventListener('change', toggleBMIValueRow);
    toggleBMIValueRow();
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cnicInput = document.getElementById('cnic');
    const cnicError = document.getElementById('cnicError');

    cnicInput.addEventListener('input', function() {
        // Only numbers, then add dashes
        let value = cnicInput.value.replace(/[^0-9]/g, '');
        if (value.length > 5) value = value.slice(0,5) + '-' + value.slice(5);
        if (value.length > 13) value = value.slice(0,13) + '-' + value.slice(13,14);
        cnicInput.value = value.slice(0,15);

        // Format check
        const regex = /^\d{5}-\d{7}-\d{1}$/;
        if (cnicInput.value.length === 15 && !regex.test(cnicInput.value)) {
            cnicError.innerText = "Format: 12345-1234567-1";
            cnicError.style.display = 'block';
            return;
        } else {
            cnicError.style.display = 'none';
        }
        // Only check existence if format is good
        if (regex.test(cnicInput.value)) {
            fetch('/check_cnic', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'cnic=' + encodeURIComponent(cnicInput.value)
            })
            .then(r => r.json())
            .then(data => {
                if (data.exists) {
                    cnicError.innerText = "This CNIC is already registered.";
                    cnicError.style.display = 'block';
                } else {
                    cnicError.style.display = 'none';
                }
            });
        }
    });
});
</script>

<script>
document.querySelector('.customer-form').addEventListener('submit', function(e) {
    const cnicError = document.getElementById('cnicError');
    if (cnicError.style.display === 'block') {
        cnicInput.focus();
        e.preventDefault();
    }
});
</script>

<script>
    $(document).ready(function() {
    $('select[name="illnesses"]').on('change', function() {
      if ($(this).val() && $(this).val().includes('Other')) {
        $('#illness_other_row').show();
      } else {
        $('#illness_other_row').hide();
      }
    }).trigger('change');
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var trainingTypeSelect = document.getElementById('training_type');
    var packageSelect = document.getElementById('package');
    var trainerRow = document.getElementById('personal_training_time_row');

    // Prepare package options for both types from Flask context (rendered into JS)
    var individualPackages = {{ individual_packages|tojson }};
    var personalPackages = {{ personal_packages|tojson }};

    function updatePackageOptions() {
        var type = trainingTypeSelect.value;
        var options = (type === 'Personal') ? personalPackages : individualPackages;
        packageSelect.innerHTML = '';
        options.forEach(function(pkg) {
            var opt = document.createElement('option');
            opt.value = pkg[0];  // id
            opt.textContent = pkg[1];  // name
            packageSelect.appendChild(opt);
        });
        // Optionally, reset selection to first option
        if (options.length > 0) packageSelect.value = options[0][0];
    }

    function toggleTrainerField() {
        if (trainingTypeSelect.value === 'Personal') {
            trainerRow.style.display = 'block';
        } else {
            trainerRow.style.display = 'none';
        }
    }

    trainingTypeSelect.addEventListener('change', function() {
        updatePackageOptions();
        toggleTrainerField();
    });

    // Set initial state
    updatePackageOptions();
    toggleTrainerField();

    // Trainer timing autofill
    var trainerSelect = document.getElementById('trainer');
    var timeInput = document.getElementById('personal_training_time');
    if (trainerSelect && timeInput) {
        function syncTime() {
            var selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
            var timing = selectedOption ? selectedOption.getAttribute('data-timing') : '';
            timeInput.value = timing || '';
        }
        trainerSelect.addEventListener('change', syncTime);
        syncTime();
    }

    // BMI Test logic (unchanged)
    var bmiTestSelect = document.getElementById('bmi_test');
    var bmiValueRow = document.getElementById('bmi_value_row');
    if (bmiTestSelect && bmiValueRow) {
        function toggleBMIValueRow() {
            if (bmiTestSelect.value === 'Yes') {
                bmiValueRow.style.display = 'block';
            } else {
                bmiValueRow.style.display = 'none';
            }
        }
        bmiTestSelect.addEventListener('change', toggleBMIValueRow);
        toggleBMIValueRow();
    }
});
</script>


<style>
.toast-error {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 260px;
    background: #d90429;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.08em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
    font-weight: 600;
    letter-spacing: 0.2px;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }
</style>
{% if form.cnic.errors %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var toast = document.createElement('div');
      toast.className = 'toast-error';
      toast.innerText = "{{ form.cnic.errors[0]|escape }}";
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 2800);
    });
  </script>
{% endif %}


{% endblock %}


<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



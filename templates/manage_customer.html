<head>
    {% block head %}
        <title>My Gym | Manage Customer</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='logo.png') }}">
        <!-- Your global CSS and meta tags here -->
    {% endblock %}
</head>
{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Manage Customer</h1>
<div class="add-customer-full-bg">
  <div class="add-customer-card customer-card">
    <a href="{{ url_for('customers') }}" class="back-btn"><i class="fa fa-arrow-left"></i> Back</a>
    <div class="customer-header">
      <div>
        {% if customer.name|length > 12 %}
          <h2 class="customer-name" title="{{ customer.name }}">{{ customer.name[:12] }}&hellip;</h2>
        {% else %}
          <h2 class="customer-name">{{ customer.name }}</h2>
        {% endif %}
        <div class="customer-membership">
          Membership No: {{ customer.membership_no or 'No data found' }}
        </div>
        <div class="customer-status-row">
          Status:
          {% if customer.status and customer.status|lower == 'active' %}
            <span class="status-badge status-active">{{ customer.status }}</span>
          {% elif customer.status and customer.status|lower == 'not paid' %}
            <span class="status-badge status-unpaid">{{ customer.status }}</span>
          {% else %}
            <span class="status-badge status-inactive">{{ customer.status or 'No data found' }}</span>
          {% endif %}
        </div>
      </div>
      <div class="customer-actions-row">
        <button class="sleet-btn status-btn" id="update-status-button" type="button" onclick="handleStatusUpdate()">
          <i class="fa fa-sync"></i> Update Status
        </button>
        <a href="{{ url_for('edit_customer', cnic=customer.cnic) }}" class="sleeted-btn">
            <i class="fa fa-edit"></i> Edit
        </a>
        <a href="#" class="sleet-btn delete-btn" onclick="openDeleteConfirmationModal()">
          <i class="fa fa-trash"></i> Delete
      </a>
      </div>
    </div>
    <hr class="customer-divider">
    <div class="customer-info-grid">
      <div><strong>Admission Date:</strong> <span>{{ customer.admission_date.strftime('%Y-%m-%d') if customer.admission_date else 'No data found' }}</span></div>
      <div><strong>Billing Date:</strong> <span>{{ customer.billing_date.strftime('%Y-%m-%d') if customer.billing_date else 'No data found' }}</span></div>
      {% set pkg = packages_dict.get(customer.package_id) %}
      <div><strong>Type:</strong> <span>{{ pkg.package_type if pkg else 'No data found' }}</span></div>
      <div><strong>Package:</strong> <span>{{ pkg.package_name if pkg else 'No data found' }}</span></div>
      <div><strong>Discount Amount:</strong> <span>{{ customer.discount_amount or 'No data found' }}</span></div>
      <div><strong>CNIC:</strong> <span>{{ customer.cnic or 'No data found' }}</span></div>
      <div><strong>Email:</strong> <span>{{ customer.email or 'No data found' }}</span></div>
      <div><strong>Phone:</strong> <span>{{ customer.phone or 'No data found' }}</span></div>
      <div><strong>Emergency Contact:</strong> <span>{{ customer.emergency_contact or 'No data found' }}</span></div>
      <div><strong>Father/Husband Name:</strong> <span>{{ customer.father_or_husband or 'No data found' }}</span></div>
      <div><strong>Gender:</strong> <span>{{ customer.gender or 'No data found' }}</span></div>
      <div><strong>Marital Status:</strong> <span>{{ customer.marital_status or 'No data found' }}</span></div>
      <div><strong>Blood Group:</strong> <span>{{ customer.blood_group or 'No data found' }}</span></div>
      <div><strong>Date of Birth:</strong> <span>{{ customer.dob.strftime('%Y-%m-%d') if customer.dob else 'No data found' }}</span></div>
      <div><strong>Height (cm):</strong> <span>{{ customer.height or 'No data found' }}</span></div>
      <div><strong>Weight (kg):</strong> <span>{{ customer.weight or 'No data found' }}</span></div>
      <div><strong>Waist (cm):</strong> <span>{{ customer.waist or 'No data found' }}</span></div>
      <div><strong>Profession:</strong> <span>{{ customer.profession or 'No data found' }}</span></div>
      <div><strong>Nationality:</strong> <span>{{ customer.nationality or 'No data found' }}</span></div>
      <div><strong>Address:</strong> <span>{{ customer.address or 'No data found' }}</span></div>
      <div><strong>Personal Training Time:</strong> <span>{{ customer.personal_training_time or 'No data found' }}</span></div>
      <div><strong>Trainer:</strong> <span>{{ customer.trainer or 'No data found' }}</span></div>
      <div><strong>BMI Test:</strong> <span>{{ customer.bmi_test or 'No data found' }}</span></div>
      <div><strong>BMI Value:</strong> <span>{{ customer.bmi_value or 'No data found' }}</span></div>
      <div><strong>Terms Accepted:</strong> <span>{{ 'Yes' if customer.terms_accepted else 'No' }}</span></div>
      <div><strong>Illnesses:</strong> <span>{{ customer.illnesses or 'No data found' }}</span></div>
      <div><strong>Join Reasons:</strong> <span>{{ customer.join_reasons or 'No data found' }}</span></div>
    </div>
    
    <div id="statusModal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
          <h2 style="margin-top:3px;margin-bottom:10px;">Update Status & Payment</h2>
          <form id="statusUpdateForm" method="POST" action="{{ url_for('update_status', cnic=customer.cnic) }}">
              <div class="form-group">
                  <label>Package</label>
                  <input type="text" value="{{ package_name }}" readonly>
              </div>
              <div class="form-group">
                  <label>Package Price</label>
                  <input type="text" id="package-price" value="{{ package_price }}" readonly>
              </div>
              <div class="form-group">
                  <label>Registration Fees</label>
                  <input type="number" min="0" step="0.01" name="registration_fees" id="registration-fees" value="{{ registration_fees }}" required>
              </div>
              <div class="form-group">
                  <label>Total Amount</label>
                  <input type="text" id="amount-to-be-paid" value="{{ amount_to_be_paid }}" readonly>
              </div>
              <div class="form-group">
                <label>Discount Amount</label>
                <input type="number" min="0" step="1" name="discount_amount" id="discount-amount" value="{{ customer.discount_amount }}" required>
            </div>

              <div class="form-group">
                  <label>Paid Amount</label>
                  <input type="number" min="0" placeholder="Enter paid amount" step="0.01" name="paid_amount" id="paid-amount-input" required>
              </div>
              <div class="form-group">
                  <label>Remaining Fees</label>
                  <input type="number" min="0" step="0.01" id="remaining-fees-input" readonly>
              </div>
              <div class="form-group">
                  <label>Next Billing Date</label>
                  <input type="date" name="next_billing_date" value="{{ customer.billing_date.strftime('%Y-%m-%d') if customer.billing_date else '' }}" required>
              </div>
              <div class="form-group">
                  <label>Payment Method</label>
                  <select name="payment_method" class="form-input" required>
                      <option value="">Select payment method</option>
                      <option value="Cash">Cash</option>
                      <option value="Online">Online</option>
                  </select>
              </div>
              <div class="form-group" id="transaction-id-group" style="display:none;">
                  <label>Transaction ID</label>
                  <input type="text" name="transaction_id" id="transaction-id" placeholder="Enter Transaction ID if payment is online">
              </div>
              <div class="form-group">
                  <label>Payment Collected By</label>
                  <select name="collector_name" class="form-input" required>
                      <option value="">Select employee</option>
                      {% for emp in employees %}
                          <option value="{{ emp.name }}">{{ emp.name }}</option>
                      {% endfor %}
                  </select>
              </div>
              <div class="modal-actions">
                  <button type="submit" class="leet-btn" style="background:#ff7300; color:#fff;">Save</button>
                  <button type="button" class="leet-btn modal-close-btn" style="background:#181818; color:#fff;" onclick="closeStatusModal()">Cancel</button>
              </div>
          </form>
      </div>
    </div>
    <!-- Confirmation Modal -->
<div id="confirmationModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 400px; padding: 20px;">
      <h2 style="margin: 0 0 20px;">Confirm Status Change</h2>
      <p style="color: #ffffff;" id="confirmationText"></p>
      <div class="modal-actions" style="display: flex; justify-content: space-between;">
          <button type="button" class="leet-btn" style="background:#ff7300; color:#fff;" onclick="confirmStatusChange()">Yes</button>
          <button type="button" class="leet-btn modal-close-btn" style="background:#181818; color:#fff;" onclick="closeConfirmationModal()">No</button>
      </div>
  </div>
</div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 400px; padding: 20px;">
      <h2 style="margin: 0 0 20px;">Confirm Deletion</h2>
      <p style="color: #fff;">Are you sure you want to delete this customer?</p>
      <div class="modal-actions" style="display: flex; justify-content: space-between;">
          <button type="button" class="leet-btn" style="background:#ff7300; color:#fff;" onclick="confirmDelete()">Yes</button>
          <button type="button" class="leet-btn modal-close-btn" style="background:#181818; color:#fff;" onclick="closeDeleteConfirmationModal()">No</button>
      </div>
  </div>
</div>

<!-- Billing Date Modal -->
<div id="billingDateModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 400px; padding: 20px;">
      <h2 style="margin: 0 0 20px;">Update Billing Date</h2>
      <form id="billingDateForm" method="POST" action="{{ url_for('update_billing_date', cnic=customer.cnic) }}">
          <div class="form-group">
              <label>Current Billing Date:</label>
              <input type="date" name="billing_date" value="{{ customer.billing_date.strftime('%Y-%m-%d') if customer.billing_date else '' }}" required>
          </div>
          <div class="modal-actions" style="display: flex; justify-content: space-between;">
              <button type="submit" class="leet-btn" style="background:#ff7300; color:#fff;">Save</button>
              <button type="button" class="leet-btn modal-close-btn" style="background:#181818; color:#fff;" onclick="closeBillingDateModal()">Cancel</button>
          </div>
      </form>
  </div>
</div>


<!-- Toast code (for success messages) -->
<style>
.toast-success {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 260px;
    background: #36b37e;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.08em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
    font-weight: 600;
    letter-spacing: 0.2px;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }
</style>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        {% for category, message in messages %}
          var toast = document.createElement('div');
          toast.className = 'toast-success';
          toast.innerText = "{{ message|escape }}";
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 2800);
        {% endfor %}
      });
    </script>
  {% endif %}
{% endwith %}

<script>
function openDeleteConfirmationModal() {
    document.getElementById('deleteConfirmationModal').style.display = 'flex';
}

function closeDeleteConfirmationModal() {
    document.getElementById('deleteConfirmationModal').style.display = 'none';
}

function confirmDelete() {
    const url = "{{ url_for('delete_customer', cnic=customer.cnic) }}";
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
    .then(response => {
        if (response.ok) {
            location.href = "{{ url_for('customers') }}"; // Redirect after deletion
        } else {
            alert('Failed to delete customer.');
        }
    });
}
</script>



<script>
function handleStatusUpdate() {
    const currentStatus = "{{ customer.status|lower }}";

    if (currentStatus === 'not paid') {
        openPaymentModal(); // Open payment modal for 'not paid' status
    } else if (currentStatus === 'inactive') {
        openBillingDateModal(); // Open billing date modal for 'inactive' status
    } else if (currentStatus === 'active') {
        // Confirm change to inactive
        newStatus = 'inactive';
        const message = `Are you sure you want to update the customer status to ${newStatus}?`;
        document.getElementById('confirmationText').innerText = message;
        document.getElementById('confirmationModal').style.display = 'flex';
    }
}

function openBillingDateModal() {
    document.getElementById('billingDateModal').style.display = 'flex';
}

function closeBillingDateModal() {
    document.getElementById('billingDateModal').style.display = 'none';
}

function openPaymentModal() {
    document.getElementById('statusModal').style.display = 'flex';
}

function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
}

function confirmStatusChange() {
    updateCustomerStatus(newStatus);
    closeConfirmationModal();
}

function closeConfirmationModal() {
    document.getElementById('confirmationModal').style.display = 'none';
}

function updateCustomerStatus(status) {
    const url = "{{ url_for('update_customer_status', customer_id=customer.id) }}";
    
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh the page to reflect changes
        }
    });
}

</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethod = document.querySelector('select[name="payment_method"]');
    const transactionGroup = document.getElementById('transaction-id-group');
    const transactionInput = document.getElementById('transaction-id');

    function toggleTransactionField() {
        if (paymentMethod.value === 'Online') {
            transactionGroup.style.display = 'block';
            transactionInput.required = true;
        } else {
            transactionGroup.style.display = 'none';
            transactionInput.required = false;
            transactionInput.value = '';
        }
    }

    paymentMethod.addEventListener('change', toggleTransactionField);
    toggleTransactionField(); // Initialize on page load
});
</script>



<script>
document.getElementById('paid-amount-input').oninput = function(){
  var total = parseInt(document.getElementById('amount-to-be-paid').value) || 0;
  var paid = parseInt(this.value) || 0;
  var rem = total - paid;
  document.getElementById('remaining-amount').value = rem >= 0 ? rem : 0;
};



document.addEventListener('DOMContentLoaded', function() {
    const packagePriceInput = document.getElementById('package-price');
    const registrationFeesInput = document.getElementById('registration-fees');
    const discountAmountInput = document.getElementById('discount-amount');
    const totalAmountInput = document.getElementById('amount-to-be-paid');
    const paidAmountInput = document.getElementById('paid-amount-input');
    const remainingFeesInput = document.getElementById('remaining-fees-input');

    function updateTotalAmount() {
        const packagePrice = parseFloat(packagePriceInput.value) || 0;
        const registrationFees = parseFloat(registrationFeesInput.value) || 0;
        const discountAmount = parseFloat(discountAmountInput.value) || 0;
        totalAmountInput.value = (packagePrice + registrationFees - discountAmount).toFixed(0);
    }

    function updateRemainingFees() {
        const totalAmount = parseFloat(totalAmountInput.value) || 0;
        const paidAmount = parseFloat(paidAmountInput.value) || 0;
        remainingFeesInput.value = (totalAmount - paidAmount).toFixed(0);
    }

    registrationFeesInput.addEventListener('input', updateTotalAmount);
    discountAmountInput.addEventListener('input', updateTotalAmount);
    paidAmountInput.addEventListener('input', updateRemainingFees);
    updateTotalAmount(); // Initialize on page load
    updateRemainingFees(); // Initialize on page load
});

</script>

{% endblock %}

{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Manage Employee</h1>
<div class="add-customer-full-bg">
  <div class="add-customer-card customer-card">
    <a href="{{ url_for('employees') }}" class="back-btn"><i class="fa fa-arrow-left"></i> Back</a>
    <div class="customer-header">
      <div>
        {% if employee.name|length > 12 %}
          <h2 class="customer-name" title="{{ employee.name }}">{{ employee.name[:12] }}&hellip;</h2>
        {% else %}
          <h2 class="customer-name">{{ employee.name }}</h2>
        {% endif %}
        <div class="customer-membership">
          Employee Status: 
          {% if employee.status and employee.status|lower == 'active' %}
            <span class="status-badge status-active">{{ employee.status }}</span>
          {% elif employee.status and employee.status|lower == 'inactive' %}
            <span class="status-badge status-inactive">{{ employee.status }}</span>
          {% else %}
            <span class="status-badge status-unpaid">{{ employee.status or 'No data found' }}</span>
          {% endif %}
        </div>
      </div>
      <div class="customer-actions-row">
        <button class="sleet-btn" type="button" onclick="openEditEmployeeModal()">
            <i class="fa fa-edit"></i> Edit
        </button>
        <a href="#" class="sleet-btn delete-btn" onclick="openDeleteConfirmationModal('{{ url_for('delete_employee', employee_id=employee.id) }}', true)">
            <i class="fa fa-trash"></i> Delete
        </a>
      </div>
    </div>
    <hr class="customer-divider">
    <div class="customers-table-wrap">
    <table class="customers-table" style="font-size: 0.97em; margin-bottom: 1px;">
        <thead>
            <tr>
                <th>Type</th>
                <th>Phone</th>
                <th>Salary</th>
                <th>Timing</th>
                <th>CNIC</th>
                <th>Shift</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ employee.employment_type or 'No data found' }}</td>
                <td>{{ employee.phone_number or 'No data found' }}</td>
                <td>{{ employee.salary or 'No data found' }}</td>
                <td>{{ employee.timing or 'No data found' }}</td>
                <td>{{ employee.cnic or 'No data found' }}</td>
                <td>{{ employee.shift or 'No data found' }}</td>
            </tr>
        </tbody>
    </table>
</div>

    <hr class="customer-divider" style="margin-top: 32px;">

<h2 style="color:#ff7300; letter-spacing:1px; margin-top: 5px; margin-bottom: 5px;">
    Salary History
</h2>
{% if total_advance > 0 %}
<div style="font-size: 0.90em; color: #ffb347; font-weight:600; margin: 5px 0 26px;">
    Total Advance Paid: {{ total_advance }}
</div>
{% endif %}
<div style="text-align: right; margin-bottom: 18px;">
  <button class="leet-btn" style="width:auto; padding:10px 22px; font-size:1em;" onclick="openPaySalaryModal()">
      <i class="fa fa-plus"></i> Pay Salary
  </button>
</div>
<div class="customers-table-wrap">
    <table class="customers-table" style="font-size: 0.97em;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Method</th>
                <th>Tr. ID</th>
                <th>Action</th> 
            </tr>
        </thead>
        <tbody>
            {% for s in salary_history %}
            <tr>
                <td>{{ s.transaction_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ s.salary_amount }}</td>
                <td>{{ s.payment_type }}</td>
                <td>{{ s.payment_method }}</td>
                <td>
                    {% if s.payment_method == 'Online' and s.transaction_id %}
                        {{ s.transaction_id }}
                    {% else %}
                        <span style="color:#aaa;">None</span>
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('delete_salary_entry', entry_id=s.id) }}" method="post" style="display:inline;">
                        <button type="button" style="padding-top: 9px; padding-bottom: 5px; width: 50px; height: 33px;" class="leet-btn delete-btn" onclick="openDeleteConfirmationModal('{{ url_for('delete_salary_entry', entry_id=s.id) }}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align:center;">No salary records found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

  </div>
</div>

<!-- Modal structure (can be hidden/shown with JS) -->
<div id="editEmployeeModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h2 style="margin-top: 1px;">Edit Employee</h2>
    <form id="editEmployeeForm" method="POST" action="{{ url_for('edit_employee_by_cnic', cnic=employee.cnic) }}">
      {{ form.hidden_tag() }}
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="name">Employee Name:</label>
        {{ form.name(class_="form-input", id="edit-name") }}
        {% for error in form.name.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="cnic">Employee CNIC:</label>
        {{ form.cnic(class_="form-input", id="edit-cnic", readonly=True) }}
        {% for error in form.cnic.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="employment_type">Employment Type:</label>
        {{ form.employment_type(class_="form-input", id="edit-employment_type") }}
        {% for error in form.employment_type.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="phone_number">Phone Number:</label>
        {{ form.phone_number(class_="form-input", id="edit-phone_number", placeholder="03XXXXXXXXX") }}
        {% for error in form.phone_number.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
        <span class="form-error" id="phoneError" style="display:none;"></span>
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="salary">Salary:</label>
        {{ form.salary(class_="form-input", id="edit-salary") }}
        {% for error in form.salary.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="timing">Timing:</label>
        <div style="display: flex; gap: 4px;">
            <input type="time" id="edit_start_time" class="form-input" required>
            <select id="edit_start_period" class="form-input" required>
                <option value="AM">AM</option>
                <option value="PM">PM</option>
            </select>
            <span style="align-self: center;">to</span>
            <input type="time" id="edit_end_time" class="form-input" required>
            <select id="edit_end_period" class="form-input" required>
                <option value="AM">AM</option>
                <option value="PM">PM</option>
            </select>
        </div>
        <input type="hidden" name="timing" id="edit-timing">
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="shift">Shift:</label>
        {{ form.shift(class_="form-input", id="edit-shift") }}
        {% for error in form.shift.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label for="status">Status:</label>
        {{ form.status(class_="form-input", id="edit-status") }}
        {% for error in form.status.errors %}
        <span class="form-error">{{ error }}</span>
        {% endfor %}
      </div>
      <div class="form-block" style="display: flex; gap: 10px;">
        <button type="submit" class="leet-btn" style="background:#ff7300; color:#fff;">Save Changes</button>
        <button type="button" class="leet-btn modal-close-btn" onclick="closeEditEmployeeModal()" style="background:#181818; color:#fff;">Cancel</button>
      </div>
    </form>
  </div>
</div>
<!-- Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 400px; padding: 20px;">
      <h2 style="margin: 0 0 20px;">Confirm Deletion</h2>
      <p style="color: #fff;">Are you sure you want to delete this entry?</p>
      <div class="modal-actions" style="display: flex; justify-content: space-between;">
          <button type="button" class="leet-btn" style="background:#ff7300; color:#fff;" onclick="confirmDelete()">Yes</button>
          <button type="button" class="leet-btn modal-close-btn" style="background:#181818; color:#fff;" onclick="closeDeleteConfirmationModal()">No</button>
      </div>
  </div>
</div>

<script>
let deleteUrl = '';
let redirectToEmployees = false;

function openDeleteConfirmationModal(url, redirect = false) {
    deleteUrl = url;
    redirectToEmployees = redirect;
    document.getElementById('deleteConfirmationModal').style.display = 'flex';
}

function closeDeleteConfirmationModal() {
    document.getElementById('deleteConfirmationModal').style.display = 'none';
}

function confirmDelete() {
    fetch(deleteUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
    .then(response => {
        if (response.ok) {
            if (redirectToEmployees) {
                location.href = "{{ url_for('employees') }}"; // Redirect to employees page
            } else {
                location.reload(); // Refresh the current page
            }
        } else {
            alert('Failed to delete entry.');
        }
    });
}
</script>

<script>
function openEditEmployeeModal() {
    const modal = document.getElementById('editEmployeeModal');
    document.getElementById('edit-name').value = {{ employee.name|tojson }};
    document.getElementById('edit-cnic').value = {{ employee.cnic|tojson }};
    document.getElementById('edit-employment_type').value = {{ employee.employment_type|tojson }};
    document.getElementById('edit-phone_number').value = {{ employee.phone_number|tojson }};
    document.getElementById('edit-salary').value = {{ employee.salary|tojson }};
    document.getElementById('edit-shift').value = {{ employee.shift|tojson }};
    document.getElementById('edit-status').value = {{ employee.status|tojson }};
    
    const timing = {{ employee.timing|tojson }};
    populateTiming(timing);

    modal.style.display = 'flex';
}

function closeEditEmployeeModal() {
    document.getElementById('editEmployeeModal').style.display = 'none';
}

function populateTiming(existingTiming) {
    const regex = /(\d{1,2}:\d{2}) (AM|PM) to (\d{1,2}:\d{2}) (AM|PM)/;
    const parts = existingTiming.match(regex);
    if (parts) {
        document.getElementById('edit_start_time').value = convertTo24Hour(parts[1], parts[2]);
        document.getElementById('edit_start_period').value = parts[2];
        document.getElementById('edit_end_time').value = convertTo24Hour(parts[3], parts[4]);
        document.getElementById('edit_end_period').value = parts[4];
    }
}

function convertTo24Hour(time, period) {
    let [hour, minute] = time.split(':');
    hour = parseInt(hour);
    if (period === 'PM' && hour !== 12) {
        hour += 12;
    } else if (period === 'AM' && hour === 12) {
        hour = 0;
    }
    return `${hour.toString().padStart(2, '0')}:${minute}`;
}

document.addEventListener('DOMContentLoaded', function() {
    const startTime = document.getElementById('edit_start_time');
    const startPeriod = document.getElementById('edit_start_period');
    const endTime = document.getElementById('edit_end_time');
    const endPeriod = document.getElementById('edit_end_period');
    const timingInput = document.getElementById('edit-timing');

    // Set initial timing from the database
    function setInitialTiming() {
        const timing = {{ employee.timing|tojson }};
        if (timing) {
            populateTiming(timing);
            updateTiming();
        }
    }

    function updateTiming() {
        const start = startTime.value ? `${convertTo12Hour(startTime.value)} ${startPeriod.value}` : '';
        const end = endTime.value ? `${convertTo12Hour(endTime.value)} ${endPeriod.value}` : '';
        timingInput.value = start && end ? `${start} to ${end}` : timingInput.value || employee.timing;
    }

    function convertTo12Hour(time) {
        let [hour, minute] = time.split(':');
        const period = hour >= 12 ? 'PM' : 'AM';
        hour = hour % 12 || 12;
        return `${hour}:${minute}`;
    }

    function populateTiming(existingTiming) {
        const regex = /(\d{1,2}:\d{2}) (AM|PM) to (\d{1,2}:\d{2}) (AM|PM)/;
        const parts = existingTiming.match(regex);
        if (parts) {
            startTime.value = convertTo24Hour(parts[1], parts[2]);
            startPeriod.value = parts[2];
            endTime.value = convertTo24Hour(parts[3], parts[4]);
            endPeriod.value = parts[4];
        }
    }

    startTime.addEventListener('change', updateTiming);
    startPeriod.addEventListener('change', updateTiming);
    endTime.addEventListener('change', updateTiming);
    endPeriod.addEventListener('change', updateTiming);

    setInitialTiming(); // Set timing on load
});

document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('edit-phone_number');
    const phoneError = document.getElementById('phoneError');

    phoneInput.addEventListener('input', function() {
        let value = phoneInput.value;
        if (value.startsWith('+')) {
            phoneError.innerText = "Please enter without country code (e.g., 03001234567).";
            phoneError.style.display = 'block';
        } else if (value.length > 11) {
            phoneInput.value = value.slice(0, 11);
            phoneError.style.display = 'none';
        } else {
            phoneError.style.display = 'none';
        }
    });
});
</script>

<style>
.toast-error {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 260px;
    background: #d90429;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.08em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
    font-weight: 600;
    letter-spacing: 0.2px;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }

input[type="time"] {
    color: #fff;
    background-color: #181818;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 8px 10px;
    appearance: none;
}
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        {% for category, message in messages %}
          var toast = document.createElement('div');
          toast.className = 'toast-success';
          toast.innerText = "{{ message|escape }}";
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 2800);
        {% endfor %}
      });
    </script>
  {% endif %}
{% endwith %}

<div id="paySalaryModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <h2>Pay Salary</h2>
    <form method="POST" action="{{ url_for('pay_salary', employee_id=employee.id) }}">
      <div class="form-block" style="margin-bottom: 10px;">
        <label>Employee Name:</label>
        <input type="text" value="{{ employee.name }}" readonly class="form-input">
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label>Salary Amount:</label>
        <input type="number" min="0" step="1" name="salary_amount" class="form-input" value="{{ employee.salary or '' }}" required>
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label>Payment Type:</label>
        <select name="payment_type" class="form-input" required>
          <option value="Salary">Salary</option>
          <option value="Advance">Advance</option>
        </select>
      </div>
      <div class="form-block" style="margin-bottom: 10px;">
        <label>Payment Method:</label>
        <select name="payment_method" class="form-input" id="salary_payment_method" required>
          <option value="">Select Method</option>
          <option value="Cash">Cash</option>
          <option value="Online">Online</option>
        </select>
      </div>
      <div class="form-block" id="salary_transaction_id_row" style="display:none; margin-bottom: 10px;">
        <label>Transaction ID:</label>
        <input type="text" name="transaction_id" id="salary_transaction_id" class="form-input" placeholder="Enter Transaction ID">
      </div>
      <div class="form-block" style="display: flex; gap: 10px;">
        <button type="submit" class="leet-btn">Save</button>
        <button type="button" class="leet-btn modal-close-btn" onclick="closePaySalaryModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
function openPaySalaryModal() {
    document.getElementById('paySalaryModal').style.display = 'flex';
}
function closePaySalaryModal() {
    document.getElementById('paySalaryModal').style.display = 'none';
}
document.getElementById('salary_payment_method').addEventListener('change', function() {
    const transactionRow = document.getElementById('salary_transaction_id_row');
    if (this.value === 'Online') {
        transactionRow.style.display = 'block';
        document.getElementById('salary_transaction_id').setAttribute('required', 'required');
    } else {
        transactionRow.style.display = 'none';
        document.getElementById('salary_transaction_id').removeAttribute('required');
    }
});
</script>

{% endblock %}

{% extends "base.html" %}
{% block content %}
<h1 style="color:#ff7300; letter-spacing:1px; margin-bottom: 28px;">Employees</h1>
<div class="customers-header" style="display: flex; justify-content: flex-end;">
    <button class="leet-btn" style="width:auto; padding:12px 26px; font-size:1em;" onclick="openAddEmployeeModal()">
        <i class="fa fa-user-plus"></i> Add Employee
    </button>
</div>
<div class="customers-table-wrap">
    <table class="customers-table">
        <thead>
            <tr>
                <th>Employee Name</th>
                <th>Employee CNIC</th>
                <th>Employment Type</th>
                <th>Phone No</th>
                <th>Shift</th>
                <th>Salary</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody class="customers-table-body">
            {% for e in employees %}
            <tr>
                <td>
                    {% if e.name and e.name|length > 20 %}
                        <span title="{{ e.name }}">{{ e.name[:20] }}&hellip;</span>
                    {% else %}
                        {{ e.name }}
                    {% endif %}
                </td>
                <td>{{ e.cnic }}</td>
                <td>{{ e.employment_type }}</td>
                <td>{{ e.phone_number }}</td>
                <td>{{ e.shift }}</td>
                <td>{{ e.salary or 'No data' }}</td>
                <td>
                    {% if e.status and e.status|lower == 'active' %}
                        <span class="status-badge status-active">{{ e.status }}</span>
                    {% elif e.status and e.status|lower == 'inactive' %}
                        <span class="status-badge status-inactive">{{ e.status }}</span>
                    {% else %}
                        <span class="status-badge status-unpaid">{{ e.status or 'Inactive' }}</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('manage_employee', employee_id=e.id) }}" class="manage-btn">Manage</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align:center; padding:20px;">No employees found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
.toast-success {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 260px;
    background: #36b37e;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.08em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
    font-weight: 600;
    letter-spacing: 0.2px;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        {% for category, message in messages %}
          var toast = document.createElement('div');
          toast.className = 'toast-success';
          toast.innerText = "{{ message|escape }}";
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 2800);
        {% endfor %}
      });
    </script>
  {% endif %}
{% endwith %}

<div id="addEmployeeModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:500px;">
    <h2 style="margin-top: 1px;">Add Employee</h2>
    <form id="addEmployeeForm" method="POST" action="{{ url_for('add_employee') }}">
      {{ form.hidden_tag() }}
      <div class="form-block" style="margin-bottom:10px;">
        <label for="name">Employee Name:</label>
        {{ form.name(class_="form-input", id="name", placeholder="Enter employee name") }}
      </div>
      <div class="form-block" style="margin-bottom:10px;">
        <label for="cnic">Employee CNIC:</label>
        <input type="text"
              name="cnic"
              id="cnic"
              class="form-input"
              maxlength="15"
              placeholder="36601-7763859-5"
              autocomplete="off"
              required>
        <span class="form-error" id="cnicError" style="display:none;"></span>
      </div>
      <div class="form-block" style="margin-bottom:10px;">
        <label for="employment_type">Employment Type:</label>
        {{ form.employment_type(class_="form-input", id="employment_type") }}
      </div>
      <div class="form-block" style="margin-bottom:10px;">
        <label for="phone_number">Phone Number:</label>
        <input type="text"
              name="phone_number"
              id="phone_number"
              class="form-input"
              maxlength="11"
              placeholder="03XXXXXXXXX"
              autocomplete="off"
              required>
        <span class="form-error" id="phoneError" style="display:none;"></span>
      </div>
      <div class="form-block" style="margin-bottom:10px;">
          <label for="timing">Timing:</label>
          <div style="display: flex; gap: 4px;">
              <input type="time" id="start_time" class="form-input" required>
              <select id="start_period" class="form-input" required>
                  <option value="AM">AM</option>
                  <option value="PM">PM</option>
              </select>
              <span style="align-self: center;">to</span>
              <input type="time" id="end_time" class="form-input" required>
              <select id="end_period" class="form-input" required>
                  <option value="AM">AM</option>
                  <option value="PM">PM</option>
              </select>
          </div>
          <input type="hidden" name="timing" id="timing">
      </div>
      <div class="form-block" style="margin-bottom:10px;">
        <label for="shift">Shift:</label>
        {{ form.shift(class_="form-input", id="shift") }}
      </div>
      <div class="form-block" style="margin-bottom:10px;">
        <label for="salary">Salary:</label>
        {{ form.salary(class_="form-input", id="salary") }}
      </div>
      <div class="form-block" style="margin-bottom:10px;">
        <label for="status">Status:</label>
        {{ form.status(class_="form-input", id="status") }}
      </div>
      <div class="form-block" style="display: flex; gap: 10px;">
        <button type="submit" class="leet-btn" id="add-employee-btn">Add Employee</button>
        <button type="button" class="leet-btn modal-close-btn" onclick="closeAddEmployeeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cnicInput = document.getElementById('cnic');
    const cnicError = document.getElementById('cnicError');
    const addBtn = document.getElementById('add-employee-btn');

    cnicInput.addEventListener('input', function() {
        let value = cnicInput.value.replace(/[^0-9]/g, '');
        if (value.length > 5) value = value.slice(0,5) + '-' + value.slice(5);
        if (value.length > 13) value = value.slice(0,13) + '-' + value.slice(13,14);
        cnicInput.value = value.slice(0,15);

        const regex = /^\d{5}-\d{7}-\d{1}$/;
        if (cnicInput.value.length === 15 && !regex.test(cnicInput.value)) {
            cnicError.innerText = "Format: 36601-7763859-5";
            cnicError.style.display = 'block';
            addBtn.disabled = true;
            return;
        } else {
            cnicError.style.display = 'none';
        }

        if (regex.test(cnicInput.value)) {
            fetch('{{ url_for("check_employee_cnic") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'cnic=' + encodeURIComponent(cnicInput.value)
            })
            .then(r => r.json())
            .then(data => {
                if (data.exists) {
                    cnicError.innerText = "This CNIC is already registered.";
                    cnicError.style.display = 'block';
                    addBtn.disabled = true;
                } else {
                    cnicError.style.display = 'none';
                    addBtn.disabled = false;
                }
            });
        }
    });

    const phoneInput = document.getElementById('phone_number');
    const phoneError = document.getElementById('phoneError');

    phoneInput.addEventListener('input', function() {
        let value = phoneInput.value;
        if (value.startsWith('+')) {
            phoneError.innerText = "Please enter without country code (e.g., 03001234567).";
            phoneError.style.display = 'block';
        } else if (value.length > 11) {
            phoneInput.value = value.slice(0, 11);
            phoneError.style.display = 'none';
        } else {
            phoneError.style.display = 'none';
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startTime = document.getElementById('start_time');
    const startPeriod = document.getElementById('start_period');
    const endTime = document.getElementById('end_time');
    const endPeriod = document.getElementById('end_period');
    const timingInput = document.getElementById('timing');

    function updateTiming() {
        const start = startTime.value ? `${startTime.value} ${startPeriod.value}` : '';
        const end = endTime.value ? `${endTime.value} ${endPeriod.value}` : '';
        timingInput.value = start && end ? `${start} to ${end}` : '';
    }

    startTime.addEventListener('change', updateTiming);
    startPeriod.addEventListener('change', updateTiming);
    endTime.addEventListener('change', updateTiming);
    endPeriod.addEventListener('change', updateTiming);
});
</script>


<script>
function openAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'flex';
}
function closeAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'none';
}
</script>

<style>
.toast-error {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 260px;
    background: #d90429;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.08em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
    font-weight: 600;
    letter-spacing: 0.2px;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }
</style>

{% endblock %}

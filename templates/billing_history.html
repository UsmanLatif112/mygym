<head>
    {% block head %}
        <title>My Gym | Billing History</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='logo.png') }}">
        <!-- Your global CSS and meta tags here -->
    {% endblock %}
</head>
{% extends "base.html" %}
{% block content %}

{% if customer.name|length > 12 %}
  <h1 style="color:#ff7300; letter-spacing:1px; margin-bottom: 10px;" title="{{ customer.name }}">
      Billing History for, {{ customer.name[:12]  }}&hellip;
  </h1>
{% else %}
  <h1 style="color:#ff7300; letter-spacing:1px; margin-bottom: 10px;">
      Billing History for, {{ customer.name }}
  </h1>
{% endif %}
<div style="font-size: 1.1em; margin-bottom: 10px; color: #fff;">
    Membership No: <span style="color:#ffb347; font-weight:600;">{{ customer.membership_no }}</span>
</div>
<div style="font-size: 0.98em; margin-bottom: 10px; color: #fff;">
    Billing Date: <span style="color:#ffb347; font-weight:600;">{{ customer.billing_date }}</span>
</div>
<div style="font-size: 0.98em; margin-bottom: 10px; color: #fff;">
    Remaining Amount: <span style="color:#ffb347; font-weight:600;">{{ current_balance }}</span>
</div>
<div style="text-align: right; margin-bottom: 26px;">
  <button class="leet-btn" style="width:auto; padding:12px 26px; font-size:1em;" onclick="openAddPaymentModal()">
      <i class="fa fa-plus"></i> Add Payment
  </button>
</div>
<div class="customers-table-wrap">
    <table class="customers-table" style="font-size: 0.99em;">
    <thead>
        <tr>
            <th style="width: 100px;">Date</th>
            <th style="width: 90px;">Amount</th>
            <th style="width: 90px;">Paid</th>
            <th style="width: 90px;">Remaining</th>
            <th style="width: 110px;">Method</th>
            <th style="width: 120px;">Tr. ID</th>
            <th style="width: 120px;">Collected By</th>
            <th style="width: 70px;">Action</th>
        </tr>
    </thead>
    <tbody class="customers-table-body">
    {% for b in history %}
    <tr>
        <td>{{ b.payment_date }}</td>  <!-- Directly use the string -->
        <td>{{ b.amount_to_be_paid }}</td>
        <td>{{ b.paid_amount }}</td>
        <td>{{ b.remaining_amount  }}</td>
        <td>{{ b.payment_method }}</td>
        <td>
            {% if b.payment_method == 'Online' and b.transaction_id %}
                {{ b.transaction_id }}
            {% else %}
                <span style="color:#aaa;">None</span>
            {% endif %}
        </td>
        <td>
            {% if b.payment_collected_by and b.payment_collected_by|length > 12 %}
                <span title="{{ b.payment_collected_by }}">{{ b.payment_collected_by[:12] }}&hellip;</span>
            {% else %}
                {{ b.payment_collected_by }}
            {% endif %}
        </td>
        <td style="display: flex; justify-content: center; gap: 2px;">
          <button type="button" class="leetpk-btn"  onclick="generateInvoice({{ b.id }})">
                <i class="fa fa-download"></i>
            </button>  
          <button type="button" class="leetpk-btn delete-btn"  onclick="openDeleteConfirmationModal('{{ url_for('delete_billing_history', billing_id=b.id, cnic=customer.cnic) }}')">
                <i class="fa fa-trash"></i>
            </button>
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="8" style="text-align:center;">No billing history found.</td>
    </tr>
    {% endfor %}
</tbody>


</table>
</div>

<div id="addPaymentModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <h2 style="margin-bottom: 5px; margin-top: 5px;">Add Payment</h2>
    <form id="addPaymentForm" method="POST" action="{{ url_for('add_billing_history', cnic=customer.cnic) }}">
      <div class="form-block" style="margin-bottom:5px;">
        <label>Customer Name:</label>
        <input type="text" value="{{ customer.name }}" readonly class="form-input">
      </div>
      <div class="form-block" style="margin-bottom:5px;">
        <label>Membership No:</label>
        <input type="text" value="{{ customer.membership_no }}" readonly class="form-input">
      </div>
      <div class="form-block" style="margin-bottom:5px;">
        <label>Package:</label>
        <input type="text" value="{{ package_name }}" readonly class="form-input">
      </div>
      <div class="form-block" style="margin-bottom:5px;">
    <label>Amount to be Paid:</label>
    <input type="number" min="0" step="1" id="modal_amount_to_be_paid" value="{{ package_price - customer.discount_amount + previous_remaining }}" readonly class="form-input">
</div>

      <div class="form-block" style="margin-bottom:5px;">
        <label>Paid Amount:</label>
        <input type="number" min="0" step="1" placeholder="Enter paid amount" id="modal_paid_amount" name="paid_amount" class="form-input" required>
      </div>
      <div class="form-block" style="margin-bottom:5px;">
        <label>Remaining Amount:</label>
        <input type="number" id="modal_remaining_fees" class="form-input" value="{{ amount_to_be_paid }}" readonly>
      </div>
      <div class="form-block" style="margin-bottom:5px;">
        <label>Payment Method:</label>
        <select name="payment_method" class="form-input" id="modal_payment_method" required>
          <option value="">Select Method</option>
          <option value="Cash">Cash</option>
          <option value="Online">Online</option>
        </select>
      </div>
      <div class="form-block" id="modal_transaction_id_row" style="display:none;">
        <label>Transaction ID:</label>
        <input type="text" name="transaction_id" placeholder="Enter transaction ID" id="modal_transaction_id" class="form-input">
      </div>
      <div class="form-block" style="margin-bottom:15px;">
        <label>Payment Collected By:</label>
        <select name="payment_collected_by" class="form-input" required>
            <option value="">Select Employee</option>
            {% for emp in employees %}
                <option value="{{ emp.name }}">{{ emp.name }}</option>
            {% endfor %}
        </select>
      </div>
      <div class="form-block" style="display: flex; gap: 10px;">
        <button type="submit" class="leet-btn">Save Payment</button>
        <button type="button" class="leet-btn modal-close-btn" onclick="closeAddPaymentModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 400px; padding: 20px;">
      <h2 style="margin: 0 0 20px;">Confirm Deletion</h2>
      <p style="color: #fff;">Are you sure you want to delete this entry?</p>
      <div class="modal-actions" style="display: flex; justify-content: space-between;">
          <button type="button" class="leet-btn" style="background:#ff7300; color:#fff;" onclick="confirmDelete()">Yes</button>
          <button type="button" class="leet-btn modal-close-btn" style="background:#181818; color:#fff;" onclick="closeDeleteConfirmationModal()">No</button>
      </div>
  </div>
</div>

<script>
function generateInvoice(billingId) {
    const billingEntries = {{ history|tojson }};
    const entry = billingEntries.find(b => b.id === billingId);

    if (entry) {
        const invoiceWindow = window.open('', '_blank', 'width=300,height=400');
        const invoiceContent = `
            <div style="font-family: Arial, sans-serif; width: 100%; padding: 10px;">
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="max-width: 100px;">
                    <h2>Shape it Up</h2>
                </div>
                <hr>
                <div style="text-align: left;">
                    <p><strong>Name:</strong> {{ customer.name }}</p>
                    <p><strong>Membership No:</strong> {{ customer.membership_no }}</p>
                    <p><strong>Amount to be Paid:</strong> ${entry.amount_to_be_paid}</p>
                    <p><strong>Paid Amount:</strong> ${entry.paid_amount}</p>
                    <p><strong>Remaining Amount:</strong> ${entry.remaining_amount}</p>
                    <p><strong>Collected By:</strong> ${entry.payment_collected_by}</p>
                    <p><strong>Payment Method:</strong> ${entry.payment_method}</p>
                    ${entry.payment_method === 'Online' ? `<p><strong>Transaction ID:</strong> ${entry.transaction_id}</p>` : ''}
                    <p><strong>Payment Date:</strong> ${entry.payment_date}</p>
                </div>
                <hr>
                <div style="text-align: center;">
                    <p>Address: 18-Civic Centre, Barkat Market, Commercial Area Garden Town, 54000,Lahore</p>
                    <p>Contact No: +92-334-4441455 +92-300-4704274</p>
                </div>
            </div>
        `;
        invoiceWindow.document.write(invoiceContent);
        invoiceWindow.document.close();
        invoiceWindow.print();
    }
}
</script>




<style>
.toast-success {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 240px;
    background: #36b37e;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.07em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
}
.toast-error {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 240px;
    background: #d90429;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.07em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        {% for category, message in messages %}
          var toast = document.createElement('div');
          toast.className = 'toast-{{ category }}';
          toast.innerText = "{{ message|escape }}";
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 2800);
        {% endfor %}
      });
    </script>
  {% endif %}
{% endwith %}

<script>
let deleteUrl = '';

function openDeleteConfirmationModal(url) {
    deleteUrl = url;
    document.getElementById('deleteConfirmationModal').style.display = 'flex';
}

function closeDeleteConfirmationModal() {
    document.getElementById('deleteConfirmationModal').style.display = 'none';
}

function confirmDelete() {
    fetch(deleteUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
    .then(response => {
        if (response.ok) {
            window.location.reload(); // Refresh the page after deletion
        } else {
            alert('Failed to delete entry.');
        }
    });
}
</script>


<script>
function openAddPaymentModal() {
    document.getElementById('addPaymentModal').style.display = 'flex';
    setupModalCalc();
}
function closeAddPaymentModal() {
    document.getElementById('addPaymentModal').style.display = 'none';
}

function setupModalCalc() {
    var paidAmountInput = document.getElementById('modal_paid_amount');
    var remainingFeesInput = document.getElementById('modal_remaining_fees');
    var amountToBePaidInput = document.getElementById('modal_amount_to_be_paid');
    var amountToBePaid = parseFloat(amountToBePaidInput.value) || 0;

    function updateRemaining() {
        var paid = parseFloat(paidAmountInput.value) || 0;
        var rem = amountToBePaid - paid;
        remainingFeesInput.value = rem; // Allow negative values if overpaid
    }

    if (paidAmountInput && remainingFeesInput) {
        paidAmountInput.removeEventListener('input', updateRemaining);
        paidAmountInput.addEventListener('input', updateRemaining);
        updateRemaining();
    }
}


document.addEventListener('DOMContentLoaded', function() {
    var paymentMethod = document.getElementById('modal_payment_method');
    var transactionRow = document.getElementById('modal_transaction_id_row');
    if (paymentMethod) {
        paymentMethod.addEventListener('change', function() {
            if (paymentMethod.value === 'Online') {
                transactionRow.style.display = 'block';
            } else {
                transactionRow.style.display = 'none';
                document.getElementById('modal_transaction_id').value = '';
            }
        });
    }
});
</script>




{% endblock %}

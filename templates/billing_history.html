{% extends "base.html" %}
{% block content %}

{% if customer.name|length > 12 %}
  <h1 style="color:#ff7300; letter-spacing:1px; margin-bottom: 10px;" title="{{ customer.name }}">
      Billing History for, {{ customer.name[:12] }}&hellip;
  </h1>
{% else %}
  <h1 style="color:#ff7300; letter-spacing:1px; margin-bottom: 10px;">
      Billing History for, {{ customer.name }}
  </h1>
{% endif %}
<div style="font-size: 1.1em; margin-bottom: 10px; color: #fff;">
    Membership No: <span style="color:#ffb347; font-weight:600;">{{ customer.membership_no }}</span>
</div>
<div style="font-size: 0.98em; margin-bottom: 10px; color: #fff;">
    Billing Date: <span style="color:#ffb347; font-weight:600;">{{ customer.billing_date }}</span>
</div>
{% if total_remaining > 0 %}
<div style="font-size: 0.98em; margin-bottom: 25px; color: #fff;">
    Total Remaining Due: <span style="color:#ffb347; font-weight:600;">{{ total_remaining }}</span>
</div>
{% endif %}
<div style="text-align: right; margin-bottom: 26px;">
  <button class="leet-btn" style="width:auto; padding:12px 26px; font-size:1em;" onclick="openAddPaymentModal()">
      <i class="fa fa-plus"></i> Add Payment
  </button>
</div>
<div class="customers-table-wrap">
    <table class="customers-table" style="font-size: 0.99em;">
    <thead>
        <tr>
            <th style="width: 100px;">Date</th>
            <th style="width: 90px;">Amount</th>
            <th style="width: 90px;">Paid</th>
            <th style="width: 90px;">Remaining</th>
            <th style="width: 110px;">Method</th>
            <th style="width: 120px;">Tr. ID</th>
            <th style="width: 120px;">Collected By</th>
            <th style="width: 70px;">Action</th>
        </tr>
    </thead>
    <tbody class="customers-table-body">
        {% for b in history %}
        <tr>
            <td>{{ b.payment_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ b.amount_to_be_paid }}</td>
            <td>{{ b.paid_amount }}</td>
            <td>{{ b.remaining_amount }}</td>
            <td>{{ b.payment_method }}</td>
            <td>
                {% if b.payment_method == 'Online' and b.transaction_id %}
                    {{ b.transaction_id }}
                {% else %}
                    <span style="color:#aaa;">None</span>
                {% endif %}
            </td>
            
            <td>
            {% if b.payment_collected_by and b.payment_collected_by|length > 12 %}
                <span title="{{ b.payment_collected_by }}">{{ b.payment_collected_by[:12] }}&hellip;</span>
            {% else %}
                {{ b.payment_collected_by }}
            {% endif %}
            </td>
            <td>
                <form method="POST" action="{{ url_for('delete_billing_history', billing_id=b.id, cnic=customer.cnic) }}" style="display:inline;">
                    <button type="submit" class="leet-btn delete-btn" style="padding: 8px 8px; font-size:0.9em;">
                        <i class="fa fa-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="8" style="text-align:center;">No billing history found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>    
</div>

<div id="addPaymentModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <h2>Add Payment</h2>
    <form id="addPaymentForm" method="POST" action="{{ url_for('add_billing_history', cnic=customer.cnic) }}">
      <div class="form-block">
        <label>Customer Name:</label>
        <input type="text" value="{{ customer.name }}" readonly class="form-input">
      </div>
      <div class="form-block">
        <label>Membership No:</label>
        <input type="text" value="{{ customer.membership_no }}" readonly class="form-input">
      </div>
      <div class="form-block">
        <label>Package:</label>
        <input type="text" value="{{ customer.package }}" readonly class="form-input">
      </div>
      <div class="form-block">
        <label>Amount to be Paid:</label>
        <input type="number" min="0" step="1" id="modal_amount_to_be_paid" name="amount_to_be_paid"
       value="{{ amount_to_be_paid }}" readonly class="form-input">
      </div>
      <div class="form-block">
        <label>Paid Amount:</label>
        <input type="number" min="0" step="1" id="modal_paid_amount" name="paid_amount" class="form-input" required>
      </div>
      <div class="form-block">
        <label>Remaining Amount:</label>
        <input type="number" id="modal_remaining_amount" name="remaining_amount" class="form-input" readonly>
      </div>
      <div class="form-block">
        <label>Collector Name:</label>
        <select name="payment_collected_by" class="form-input" required>
            <option value="">Select Employee</option>
            {% for emp in employees %}
                <option value="{{ emp.name }}">{{ emp.name }}</option>
            {% endfor %}
        </select>
      </div>
      <div class="form-block">
        <label>Payment Method:</label>
        <select name="payment_method" class="form-input" id="modal_payment_method" required>
          <option value="">Select Method</option>
          <option value="Cash">Cash</option>
          <option value="Online">Online</option>
        </select>
      </div>
      <div class="form-block" id="modal_transaction_id_row" style="display:none;">
        <label>Transaction ID:</label>
        <input type="text" name="transaction_id" id="modal_transaction_id" class="form-input">
      </div>
      <div class="form-block" style="display: flex; gap: 10px;">
        <button type="submit" class="leet-btn">Save Payment</button>
        <button type="button" class="leet-btn modal-close-btn" onclick="closeAddPaymentModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<style>
.toast-success {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 240px;
    background: #36b37e;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.07em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
}
.toast-error {
    position: fixed;
    top: 36px;
    right: 36px;
    min-width: 240px;
    background: #d90429;
    color: #fff;
    padding: 16px 30px;
    border-radius: 8px;
    font-size: 1.07em;
    box-shadow: 0 4px 24px #0002;
    z-index: 9999;
    opacity: 0.97;
    animation: toast-in 0.3s, toast-out 0.4s 2.4s forwards;
}
@keyframes toast-in { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.97; transform: translateY(0);} }
@keyframes toast-out { from {opacity: 0.97;} to {opacity: 0;} }
</style>


<script>
function openAddPaymentModal() {
    document.getElementById('addPaymentModal').style.display = 'flex';
}
function closeAddPaymentModal() {
    document.getElementById('addPaymentModal').style.display = 'none';
}
document.addEventListener('DOMContentLoaded', function() {
    var paymentMethod = document.getElementById('modal_payment_method');
    var transactionRow = document.getElementById('modal_transaction_id_row');
    if (paymentMethod) {
      paymentMethod.addEventListener('change', function() {
          if (paymentMethod.value === 'Online') {
              transactionRow.style.display = 'block';
          } else {
              transactionRow.style.display = 'none';
              document.getElementById('modal_transaction_id').value = '';
          }
      });
    }
    // Calculate Remaining Amount
    var amountToBePaidInput = document.getElementById('modal_amount_to_be_paid');
    var paidAmountInput = document.getElementById('modal_paid_amount');
    var remainingAmountInput = document.getElementById('modal_remaining_amount');
    function updateRemaining() {
        var total = parseFloat(amountToBePaidInput.value) || 0;
        var paid = parseFloat(paidAmountInput.value) || 0;
        var rem = total - paid;
        remainingAmountInput.value = rem >= 0 ? rem : 0;
    }
    paidAmountInput.addEventListener('input', updateRemaining);
    // Set initial value
    updateRemaining();
});
</script>


{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        {% for category, message in messages %}
          var toast = document.createElement('div');
          toast.className = 'toast-{{ category }}';
          toast.innerText = "{{ message|escape }}";
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 2800);
        {% endfor %}
      });
    </script>
  {% endif %}
{% endwith %}


{% endblock %}



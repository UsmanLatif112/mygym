{% extends "base.html" %}
{% set hide_sidebar = True %}
{% block content %}
<div class="add-customer-full-bg">
  <div class="add-customer-card">
    <a href="{{ url_for('manage_customer', cnic=customer.cnic) }}" class="back-btn"><i class="fa fa-arrow-left"></i> Back</a>
    <h1>Edit Customer</h1>
    <form method="POST" class="customer-form">
        {{ form.hidden_tag() }}

        <div class="form-block">
            <label>Membership No:</label>
            <span class="readonly-field">{{ customer.membership_no }}</span>
        </div>
        <div class="form-block">
    <label for="admission_date">Admission Date</label>
    {{ form.admission_date(class_="form-input", id="admission_date", type="date") }}
    {% for error in form.admission_date.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}
</div>

        <div class="form-block">
            <label for="name">Full Name</label>
            {{ form.name(class_="form-input", id="name") }}
            {% for error in form.name.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="father_or_husband">Father/Husband Name</label>
            {{ form.father_or_husband(class_="form-input", id="father_or_husband") }}
            {% for error in form.father_or_husband.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="cnic">CNIC</label>
            {{ form.cnic(class_="form-input", id="cnic", readonly=true) }}
            {% for error in form.cnic.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="email">Email</label>
            {{ form.email(class_="form-input", id="email") }}
            {% for error in form.email.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="gender">Gender</label>
            {{ form.gender(class_="form-input", id="gender") }}
            {% for error in form.gender.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="marital_status">Marital Status</label>
            {{ form.marital_status(class_="form-input", id="marital_status") }}
            {% for error in form.marital_status.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="blood_group">Blood Group</label>
            {{ form.blood_group(class_="form-input", id="blood_group") }}
            {% for error in form.blood_group.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="dob">Date of Birth</label>
            {{ form.dob(class_="form-input", id="dob", type="date") }}
            {% for error in form.dob.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="height">Height (cm)</label>
            {{ form.height(class_="form-input", id="height") }}
            {% for error in form.height.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="weight">Weight (kg)</label>
            {{ form.weight(class_="form-input", id="weight") }}
            {% for error in form.weight.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="waist">Waist (cm) <span style="font-weight:400; color:#aaa;">(optional)</span></label>
            {{ form.waist(class_="form-input", id="waist") }}
            {% for error in form.waist.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="profession">Profession</label>
            {{ form.profession(class_="form-input", id="profession") }}
            {% for error in form.profession.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="nationality">Nationality</label>
            {{ form.nationality(class_="form-input", id="nationality") }}
            {% for error in form.nationality.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="address">Address</label>
            {{ form.address(class_="form-input textarea-nonresize", id="address") }}
            {% for error in form.address.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="phone">Phone Number</label>
            {{ form.phone(class_="form-input", id="phone") }}
            {% for error in form.phone.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="emergency_contact">Emergency Contact No</label>
            {{ form.emergency_contact(class_="form-input", id="emergency_contact") }}
            {% for error in form.emergency_contact.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
    <label for="training_type">Training Type</label>
    {{ form.training_type(class_="form-input", id="training_type") }}
    {% for error in form.training_type.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}
</div>

<div class="form-block">
    <label for="package">Package</label>
    <select name="package" class="form-input" id="package">
        {% set current_choices = individual_packages if form.training_type.data != 'Personal' else personal_packages %}
        {% for val, label in current_choices %}
            <option value="{{ val }}" {% if form.package.data == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    {% for error in form.package.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}
</div>

<div class="form-block" id="personal_training_time_row" style="display:none;">
    <label for="trainer">Trainer</label>
    <select name="trainer" class="form-input" id="trainer">
        <option value="">Select Trainer</option>
        {% for t in trainers %}
            <option value="{{ t.name }}"
                data-timing="{{ t.timing or '' }}"
                {% if form.trainer.data == t.name %}selected{% endif %}
            >{{ t.name }}</option>
        {% endfor %}
    </select>
    {% for error in form.trainer.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}

    <label for="personal_training_time">Preferred Training Time</label>
    {{ form.personal_training_time(class_="form-input", id="personal_training_time", readonly=True) }}
    {% for error in form.personal_training_time.errors %}
        <span class="form-error">{{ error }}</span>
    {% endfor %}
</div>



        <div class="form-block">
            <label for="bmi_test">BMI Test</label>
            {{ form.bmi_test(class_="form-input", id="bmi_test") }}
            {% for error in form.bmi_test.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block" id="bmi_value_row" style="display:none;">
            <label for="bmi_value">BMI Value</label>
            {{ form.bmi_value(class_="form-input", id="bmi_value") }}
            {% for error in form.bmi_value.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <a href="https://mygymlahore.com/bmi-calculator.html" target="_blank" style="color:#58a6ff;">Go to BMI Calculator</a>
        </div>
        <div class="form-block">
            <label for="illnesses">Do you suffer from any of these illnesses?</label>
            {{ form.illnesses(class_="form-input", id="illnesses") }}
            {% for error in form.illnesses.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <label for="join_reasons">Why do you want to join?</label>
            {{ form.join_reasons(class_="form-input", id="join_reasons") }}
            {% for error in form.join_reasons.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-blockcheck terms-row">
            {{ form.terms_accepted() }} {{ form.terms_accepted.label }}
            <a href="{{ url_for('terms') }}" target="_blank" style="color:#58a6ff;">Terms and Conditions</a>
            {% for error in form.terms_accepted.errors %}
                <span class="form-error">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-block">
            <input type="submit" class="leet-btn" value="Update Customer" />
        </div>
    </form>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var trainerSelect = document.getElementById('trainer');
    var timeInput = document.getElementById('personal_training_time');

    function syncTime() {
        var selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
        var timing = selectedOption ? selectedOption.getAttribute('data-timing') : '';
        timeInput.value = timing || '';
    }

    trainerSelect.addEventListener('change', syncTime);
    syncTime(); // Make sure it's set correctly on page load
});
</script>



<script>
document.addEventListener('DOMContentLoaded', function() {
    var illnessesWhitelist = [
      "Diabetes", "Blood Pressure", "Heart Disease", "High Cholesterol", "Depression/Anxiety", "Asthma", "Arthritis", "Osteoporosis", "Thyroid Issues", "Back Pain"
    ];
    var joinReasonsWhitelist = [
      "General Fitness", "Weight Reduction", "Dietary Advice", "Stress Management", "Sports Specific Exercise", "Body Building", "Weight Gain"
    ];

    // Illnesses
    var illnessesInput = document.querySelector('#illnesses');
    if (illnessesInput) {
        new Tagify(illnessesInput, {
            whitelist: illnessesWhitelist,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: false
            },
            enforceWhitelist: false, // allows custom values
        });
    }

    // Join Reasons
    var joinReasonsInput = document.querySelector('#join_reasons');
    if (joinReasonsInput) {
        new Tagify(joinReasonsInput, {
            whitelist: joinReasonsWhitelist,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: false
            },
            enforceWhitelist: false,
        });
    }
});
</script>

<script>
  $(function() {
    $('.select2').select2({ width: '100%' });

    $('#package').on('change', function() {
      if ($(this).val().startsWith('Personal')) {
        $('#personal_training_time_row').show();
      } else {
        $('#personal_training_time_row').hide();
      }
    }).trigger('change');

    $('select[name="bmi_test"]').on('change', function() {
      if ($(this).val() === 'Yes') {
        $('#bmi_value_row').show();
      } else {
        $('#bmi_value_row').hide();
      }
    }).trigger('change');

    $('select[name="illnesses"]').on('change', function() {
      if ($(this).val() && $(this).val().includes('Other')) {
        $('#illness_other_row').show();
      } else {
        $('#illness_other_row').hide();
      }
    }).trigger('change');
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var trainingTypeSelect = document.getElementById('training_type');
    var packageSelect = document.getElementById('package');
    var trainerRow = document.getElementById('personal_training_time_row');
    var individualPackages = {{ individual_packages|tojson }};
    var personalPackages = {{ personal_packages|tojson }};

    function updatePackageOptions() {
        var type = trainingTypeSelect.value;
        var options = (type === 'Personal') ? personalPackages : individualPackages;
        packageSelect.innerHTML = '';
        options.forEach(function(pkg) {
            var opt = document.createElement('option');
            opt.value = pkg[0];
            opt.textContent = pkg[1];
            packageSelect.appendChild(opt);
        });
        // Set value to match form.package.data or first option
        var selected = "{{ form.package.data }}";
        if (selected && options.find(p => p[0] === selected)) {
            packageSelect.value = selected;
        } else if (options.length > 0) {
            packageSelect.value = options[0][0];
        }
    }
    function toggleTrainerField() {
        if (trainingTypeSelect.value === 'Personal') {
            trainerRow.style.display = 'block';
        } else {
            trainerRow.style.display = 'none';
        }
    }
    trainingTypeSelect.addEventListener('change', function() {
        updatePackageOptions();
        toggleTrainerField();
    });
    updatePackageOptions();
    toggleTrainerField();

    // Trainer timing autofill
    var trainerSelect = document.getElementById('trainer');
    var timeInput = document.getElementById('personal_training_time');
    if (trainerSelect && timeInput) {
        function syncTime() {
            var selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
            var timing = selectedOption ? selectedOption.getAttribute('data-timing') : '';
            timeInput.value = timing || '';
        }
        trainerSelect.addEventListener('change', syncTime);
        syncTime();
    }
});
</script>

{% endblock %}
